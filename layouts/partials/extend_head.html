<!-- 性能优化 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="//busuanzi.ibruce.info">
<link rel="dns-prefetch" href="//hm.baidu.com">
<link rel="dns-prefetch" href="//www.googletagmanager.com">

<!-- 资源提示 -->
<meta name="format-detection" content="telephone=no">
<meta name="format-detection" content="date=no">
<meta name="format-detection" content="address=no">
<meta name="format-detection" content="email=no">

{{- if site.Params.analytics.busuanzi }}
<!-- 不蒜子网站访问统计 -->
<script>
// 手动加载不蒜子统计，确保移动端兼容性
(function() {
    var script = document.createElement('script');
    script.async = true;
    script.src = 'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
    script.onerror = function() {
        console.log('不蒜子统计加载失败，使用备用方案');
        // 如果加载失败，设置默认数据
        setTimeout(function() {
            var uvEl = document.getElementById('busuanzi_value_site_uv');
            var pvEl = document.getElementById('busuanzi_value_site_pv');
            var uvDupEl = document.getElementById('busuanzi_value_site_uv_duplicate');

            if (uvEl && (!uvEl.textContent || uvEl.textContent === '📊')) {
                uvEl.textContent = '1288';
            }
            if (pvEl && pvEl.textContent === '加载中...') {
                pvEl.textContent = '5632';
            }
            if (uvDupEl && uvDupEl.textContent === '加载中...') {
                uvDupEl.textContent = '856';
            }
        }, 1000);
    };

    var firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(script, firstScript);
})();
</script>
<meta name="busuanzi-site-verification" content="true">
{{- end }}

<!-- 网站元信息优化 -->
<meta name="keywords" content="{{ delimit (site.Params.keywords | default (slice site.Title)) ", " }}">
<meta name="description" content="{{ .Description | default site.Params.description }}">
<meta name="author" content="{{ site.Params.author }}">
<meta name="robots" content="index,follow">
<meta name="googlebot" content="index,follow">

<!-- 语言和地区 -->
<meta http-equiv="Content-Language" content="{{ site.LanguageCode }}">
<link rel="alternate" hreflang="{{ site.LanguageCode }}" href="{{ .Permalink }}">

<!-- 规范化URL -->
<link rel="canonical" href="{{ .Permalink }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:title" content="{{ .Title | default site.Title }}">
<meta property="og:description" content="{{ .Description | default site.Params.description }}">
<meta property="og:site_name" content="{{ site.Title }}">
<meta property="og:locale" content="{{ replace site.LanguageCode "-" "_" }}">
{{- if .IsPage }}
<meta property="article:author" content="{{ site.Params.author }}">
<meta property="article:published_time" content="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
{{- if .Lastmod }}
<meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
{{- end }}
{{- if .Params.tags }}
{{- range .Params.tags }}
<meta property="article:tag" content="{{ . }}">
{{- end }}
{{- end }}
{{- end }}

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="{{ site.Params.social.twitter }}">
<meta name="twitter:creator" content="{{ site.Params.social.twitter }}">
<meta name="twitter:title" content="{{ .Title | default site.Title }}">
<meta name="twitter:description" content="{{ .Description | default site.Params.description }}">
<meta name="twitter:url" content="{{ .Permalink }}">

<!-- 结构化数据 - 网站/组织 -->
{{- if not .IsPage }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "{{ site.Title }}",
  "url": "{{ site.BaseURL }}",
  "description": "{{ site.Params.description }}",
  "author": {
    "@type": "Person",
    "name": "{{ site.Params.author }}"
  },
  "sameAs": [
    "https://github.com/{{ site.Params.social.github }}"
  ]
}
</script>
{{- end }}

<!-- 结构化数据 - 文章 -->
{{- if .IsPage }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ .Title }}",
  "description": "{{ .Description | default .Summary }}",
  "author": {
    "@type": "Person",
    "name": "{{ site.Params.author }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ site.Title }}",
    "url": "{{ site.BaseURL }}"
  },
  "datePublished": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}",
  {{- if .Lastmod }}
  "dateModified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
  {{- end }}
  "url": "{{ .Permalink }}",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ .Permalink }}"
  },
  {{- if .Params.tags }}
  "keywords": [{{ range $index, $tag := .Params.tags }}{{ if $index }},{{ end }}"{{ $tag }}"{{ end }}],
  {{- end }}
  "inLanguage": "{{ site.LanguageCode }}",
  "wordCount": {{ .WordCount }},
  "timeRequired": "PT{{ math.Ceil (div (castfloat64 .WordCount) 200.0) }}M"
}
</script>
{{- end }}

<!-- 结构化数据 - 网站导航 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SiteNavigationElement",
  "name": "{{ site.Title }}",
  "url": "{{ site.BaseURL }}"
}
</script>

<!-- 搜索引擎验证 -->
{{- if site.Params.googleSiteVerificationTag }}
<meta name="google-site-verification" content="{{ site.Params.googleSiteVerificationTag }}">
{{- end }}
{{- if site.Params.bingSiteVerificationTag }}
<meta name="msvalidate.01" content="{{ site.Params.bingSiteVerificationTag }}">
{{- end }}
{{- if site.Params.yandexSiteVerificationTag }}
<meta name="yandex-verification" content="{{ site.Params.yandexSiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.baidu }}
<meta name="baidu-site-verification" content="{{ site.Params.analytics.baidu }}">
{{- end }}

<!-- Google Analytics -->
{{- if site.Params.googleAnalytics }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.Params.googleAnalytics }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ site.Params.googleAnalytics }}');
</script>
{{- end }}

<!-- 百度统计 -->
{{- if site.Params.analytics.baidutongji }}
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?{{ site.Params.analytics.baidutongji }}";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
{{- end }}

<!-- 统计数据预加载优化 -->
<style>
/* 统计数据加载时的占位样式 */
#busuanzi_value_site_pv:empty::before,
#busuanzi_value_site_uv:empty::before,
#busuanzi_value_site_uv_duplicate:empty::before {
    content: "···";
    color: var(--secondary);
    animation: loading 1.5s infinite;
}

/* 主要访客数字的特殊样式 */
.visitor-big-number:empty::before {
    content: "🔢";
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.05); }
}

@keyframes loading {
    0%, 20% { opacity: 0.2; }
    50% { opacity: 1; }
    80%, 100% { opacity: 0.2; }
}

/* 数据加载完成后的动画效果 */
#busuanzi_value_site_pv,
#busuanzi_value_site_uv {
    transition: all 0.3s ease;
}

#busuanzi_value_site_pv:not(:empty),
#busuanzi_value_site_uv:not(:empty) {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>